package api

import (
	"OLXbaSurfer/models"
	"encoding/json"
	"errors"
	"io"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"testing"
)

type MockClient struct {
}

// SearchArticlesWithQuery runs a query to search for articles with given query and returns the result.
func (mockClient *MockClient) SearchArticlesWithQuery(query string) ([]models.Article, error) {
	handler := func(w http.ResponseWriter, r *http.Request) {
		io.WriteString(w, MockResponseFromServer())
	}

	req := httptest.NewRequest("GET", "http://olx.ba/test", nil)
	w := httptest.NewRecorder()
	handler(w, req)

	resp := w.Result()
	body, _ := ioutil.ReadAll(resp.Body)

	articles := []models.Article{}
	searchResults := models.SearchResult{}
	json.Unmarshal(body, &searchResults)
	if searchResults.Success == false {
		return articles, errors.New("API call not successful")
	}

	articles = append(articles, searchResults.Articles...)

	return articles, nil
}

func MockResponseFromServer() string {
	return `{"success":true,"broj_rezultata":175,"artikli":[{"id":37351429,"naslov":"COO tastatura case iPad 9.7 2018, 2017, iPad Air 1\/2","ima_dostavu":false,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-03\/10\/12\/slika-2174866-5e67809863f1b","cijena":"60 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598162343,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":37351869,"naslov":"Earto tastatura case iPad 9.7 2017\/2018, Pro, Air 1\/2","ima_dostavu":false,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-03\/10\/01\/slika-2174866-5e67838adbfd9","cijena":"70 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598122023,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":39483008,"naslov":"IPad Air 2 64gb-128gb","ima_dostavu":false,"slika":"","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1598104112,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":false,"vrsta_prodaje":4,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":14899924,"naslov":"Gel maska za iPad Air 2 vi\u0161e boja","ima_dostavu":false,"slika":"https:\/\/s4.pik.ba\/galerija\/2014-12\/05\/05\/slika-10817-5481def1ee1a5","cijena":"12 KM","kategorija":"Maske\/Oklopi","timestamp":1598100074,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":34555641,"naslov":"KAKU futrola za iPad 9.7'' (2018)\/Air 2\/Air","ima_dostavu":false,"slika":"https:\/\/s5.pik.ba\/galerija\/2019-07\/17\/03\/slika-10817-5d2f20326a172","cijena":"30 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598098711,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":15,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":17579877,"naslov":"Za\u0161titno staklo za tablet iPad Air 2","ima_dostavu":false,"slika":"https:\/\/s5.pik.ba\/galerija\/2019-10\/08\/03\/slika-10817-5d9c8b53cc0e1","cijena":"20 KM","kategorija":"Folije\/Za\u0161tite za ekran","timestamp":1598095784,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":39480739,"naslov":"Ipad 2 i ipad air 65KM oba","ima_dostavu":true,"slika":"https:\/\/s9.pik.ba\/galerija\/2020-08\/22\/12\/slika-493101-5f40f6c7e5335","cijena":"65 KM","kategorija":"Tableti u dijelovima","timestamp":1598093084,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741386,"naslov":"Apple Ipad Air 2 WiFi 64GB BIJELI 9,7 **NOVO** Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e85db9b3","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1598092754,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741658,"naslov":"Apple Ipad Air 2 WiFi 16GB GRAY 9,7 *KAO NOVO* Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e80b17fe","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1598092731,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741644,"naslov":"Apple Ipad Air 2 WiFi 128GB GOLD 9,7 *KAO NOVO* Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e7b2162c","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1598092721,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":34313820,"naslov":"Ipad air 2 za dijelova ploca ispravna 2 kom","ima_dostavu":true,"slika":"https:\/\/s9.pik.ba\/galerija\/2020-06\/18\/07\/slika-76505-5eeb9e39ad2e6","cijena":"250 KM","kategorija":"Tableti u dijelovima","timestamp":1598091882,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":37367738,"naslov":"Ipad Air 2 flip case preklopna futrola sa magnetom","ima_dostavu":true,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-03\/11\/04\/slika-36811-5e68feaa508be","cijena":"25 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598087187,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":37350463,"naslov":"DINGRICH tastatura case iPad 10.2, Air 3, Pro 10.5","ima_dostavu":false,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-03\/10\/11\/slika-2174866-5e6770d75bb1e","cijena":"80 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598085183,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":37457524,"naslov":"Arteck tastatura za apple iPad Air 2, iPad Pro 9.7\"","ima_dostavu":false,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-03\/19\/09\/slika-2174866-5e732cddd0839","cijena":"60 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598084643,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":38593381,"naslov":"Tastatura case iPad Pro 9.7 iPad Air 2\/Air 1, LED RGB","ima_dostavu":true,"slika":"https:\/\/s9.pik.ba\/galerija\/2020-06\/18\/10\/slika-126923-5eebc8bf86ca0","cijena":"70 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598083683,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":38184631,"naslov":"Futrola za Apple Ipad Air 2 i Ipad pro 9.7","ima_dostavu":true,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-05\/18\/08\/slika-600856-5ec2d7633f158","cijena":"30 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598077617,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":false,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":true},{"id":37486612,"naslov":"Ipad air 2 64gb wifi","ima_dostavu":true,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-03\/22\/10\/slika-617116-5e77310d5f6e4","cijena":"400 KM","kategorija":"Tablet PCs","timestamp":1598048603,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":37095058,"naslov":"Ipad air 2 djelovi A1566 Ploca","ima_dostavu":true,"slika":"https:\/\/s5.pik.ba\/galerija\/2020-02\/20\/07\/slika-617116-5e4e2d23c2d0e","cijena":"100 KM","kategorija":"Tableti u dijelovima","timestamp":1598048495,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":38277758,"naslov":"Punjac za ipad air 2 iphone orginalni","ima_dostavu":false,"slika":"https:\/\/s9.pik.ba\/galerija\/2020-05\/26\/02\/slika-617116-5ecd083f75755","cijena":"10 KM","kategorija":"Punja\u010di","timestamp":1598048482,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":4,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":39235446,"naslov":"Oklop za iPad Air 2, ESR, Space Gray","ima_dostavu":true,"slika":"https:\/\/s9.pik.ba\/galerija\/2020-07\/31\/05\/slika-801426-5f243498c025c","cijena":"25 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1598027872,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":35805964,"naslov":"Baterija Apple iPad Air 2 A1547 (ORIGINAL)","ima_dostavu":true,"slika":"https:\/\/s5.pik.ba\/galerija\/2019-11\/06\/12\/slika-3022-5dc2aaec989d4","cijena":"65 KM","kategorija":"Baterije","timestamp":1598001724,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":10,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":25741383,"naslov":"Apple Ipad Air 2 WiFi 128GB SILVER 9,7 **NOVO** Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e85db9b3","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1597998851,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741657,"naslov":"Apple Ipad Air 2 WiFi 16GB GOLD 9,7 *KAO NOVO* Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e7b2162c","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1597998837,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741385,"naslov":"Apple Ipad Air 2 WiFi 64GB GRAY 9,7 **NOVO** Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e80b17fe","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1597998832,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741382,"naslov":"Apple Ipad Air 2 WiFi 128GB CRNI 9,7 **NOVO** Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e80b17fe","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1597998756,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":30564501,"naslov":"Apple Leather Smart Case for iPad Air 2","ima_dostavu":true,"slika":"https:\/\/s8.pik.ba\/galerija\/2018-08\/02\/07\/slika-281785-5b6342b10acd5","cijena":"199 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1597843193,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":true,"podrzava_kolicinu":true,"besplatna_dostava":false},{"id":38573392,"naslov":"IPAD 6 IPAD PRO AIR 2 IPAD PRO 2019 ICLOUD ZAKLJUCAN","ima_dostavu":false,"slika":"https:\/\/s9.pik.ba\/galerija\/2020-06\/17\/02\/slika-1473164-5eea139f090b1","cijena":"Po dogovoru","kategorija":"Tableti u dijelovima","timestamp":1597824105,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":false,"vrsta_prodaje":4,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":21357634,"naslov":"360c rotaciona futrola za iPad Air 2 razne boje","ima_dostavu":false,"slika":"https:\/\/s6.pik.ba\/galerija\/2016-04\/07\/11\/slika-10817-5706252ff1c8c","cijena":"25 KM","kategorija":"Tastature\/futrole za tablete","timestamp":1597765906,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741656,"naslov":"Apple Ipad Air 2 WiFi 64GB BIJELI 9,7 *KAO NOVO* Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e85db9b3","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1597743613,"izdvojen":0,"istakni":false,"hitno":false,"novo":false,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false},{"id":25741381,"naslov":"Apple Ipad Air 2 WiFi 128GB GOLD 9,7 **NOVO** Wi-Fi","ima_dostavu":false,"slika":"https:\/\/s7.pik.ba\/galerija\/2017-05\/29\/03\/slika-684264-592c1e7b2162c","cijena":"Po dogovoru","kategorija":"Tablet PCs","timestamp":1597743515,"izdvojen":0,"istakni":false,"hitno":false,"novo":true,"vidljiv":1,"radnja":true,"vrsta_prodaje":0,"kolicina":1,"prikazi_kolicinu":false,"podrzava_kolicinu":false,"besplatna_dostava":false}],"filteri":[],"odabrani_filteri":[{"naziv":"Pretraga","name":"trazilica","vrsta":"select","value":"Rije\u010di: ipad air 2"},{"naziv":"Pretraga","name":"trazilica","vrsta":"select","value":"Rije\u010di: ipad air 2"},{"naziv":"Pretraga","name":"trazilica","vrsta":"select","value":"Rije\u010di: ipad air 2"}],"predefinisana_kat":0,"kategorije":[{"id":3,"naziv":"Mobilni ure\u0111aji","podkategorije":[{"id":2331,"broj_rezultata":90,"naziv":"Tastature\/futrole za tablete"},{"id":1495,"broj_rezultata":65,"naziv":"Tablet PCs"},{"id":2330,"broj_rezultata":6,"naziv":"Tableti u dijelovima"},{"id":1526,"broj_rezultata":4,"naziv":"Folije\/Za\u0161tite za ekran"},{"id":253,"broj_rezultata":2,"naziv":"Baterije"},{"id":1092,"broj_rezultata":2,"naziv":"Maske\/Oklopi"},{"id":31,"broj_rezultata":1,"naziv":"Mobiteli"},{"id":254,"broj_rezultata":1,"naziv":"Punja\u010di"}],"broj_rezultata":171},{"id":5,"naziv":"Kompjuteri","podkategorije":[{"id":38,"broj_rezultata":1,"naziv":"Desktop Ra\u010dunari"},{"id":39,"broj_rezultata":1,"naziv":"Laptopi"},{"id":1192,"broj_rezultata":1,"naziv":"Display za laptope"}],"broj_rezultata":3},{"id":67,"naziv":"Muzi\u010dka oprema","podkategorije":[{"id":1564,"broj_rezultata":1,"naziv":"Stalci"}],"broj_rezultata":1}]}`
}

func TestSearchArticlesWithQuery(t *testing.T) {
	mockClient := MockClient{}
	articles, err := mockClient.SearchArticlesWithQuery("Test query #1")
	if err != nil {
		t.Error(err)
	}

	if len(articles) != 30 {
		t.Error("Invalid article count")
	}
}
